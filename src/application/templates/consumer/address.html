{% extends "consumer/consumer_base.html" %}
{% block title %}FoodyPulse - Home{% endblock %}

{% block head %}
    <style>
        .header {
            width: 90%;
            margin: auto;
        }

        .header h4 {
            display: inline-block;
            font-size: 25px;
            padding-top: 10px;
        }

        .addressDiv {
            background-color: #ffffff;
            width: 30%;
        }

        .inputs {
            width: 90%;
            margin: auto;
        }

        .form-control {
            margin: 10px auto;
            height: 150px;
        }

        label {
            margin-top: 10px;
        }

        #map {
            height: 250px;
            width: 90%;
            margin: auto;
        }

        .orderConfirm {
            width: 60%;
            float: right;
            margin-top: -200px;;
        }
    </style>
{% endblock %}

{% block content %}
    {% from "includes/_formHelper.html" import render_field %}
    <script>
        function initMap() {
            // the location of Nanyang Polytechnic
            const location = {lat: {{ latitude }}, lng: {{ longitude }}};
            // center the map at nyp
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 17,
                center: location,
            });
            const marker = new google.maps.Marker({
                position: location,
                map: map,
            });
        }
    </script>

    <form method="POST" action="{{ url_for('consumer_myaddress', restaurant_id=restaurant.id) }}">
        <div class="addressDiv">
            <div class="header">
                <img src="{{ url_for("static", filename="cart/location.png") }}" alt="location Logo"
                     style="height: 35px; width: 40px; margin: 15px 0px; display: inline-block">
                <h4 style="margin-left: 20px;">Delivery Address</h4>
            </div>

            <div id="map"></div>

            <div class="inputs">
                <div class="form-group">{{ render_field(form.consumer_address, class="form-control", placeholder='Enter Address here') }}</div>

                <input type="submit" value="Submit" class="btn btn-primary" style="margin: 20px 0;"/>
            </div>

            {# async script executes immediately and msut be after any DOM elements used in callbacl. #}
            <script
                    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCu8EK_J5eGH_o7frDEGfeWEJfWJIY6hbE&callback=initMap&libraries=&v=weekly"
                    async
            ></script>
        </div>
    </form>

    <div class="orderConfirm">
        {% for cart_item in cart_items %}
            <div class="card rounded-3 mb-4 display-right">
                <div class="card-body p-4">
                    <div
                            class="row d-flex justify-content-between align-items-center">
                        <div class="col-md-3 col-lg-3 col-xl-2 d-flex">
                            <p class="lead fw-normal mb-2">{{ cart_item.qty }}x </p>
                        </div>
                        <div class="col-md-3 col-lg-3 col-xl-3">
                            <p class="lead fw-normal mb-2">{{ cart_item.food.name }}</p>
                        </div>
                        <div class="col-md-3 col-lg-2 col-xl-2 offset-lg-1">
                            {% if cart_item.is_discounted() %}
                                <h5 class="mb-0" style="text-decoration: line-through">
                                    ${{ "%.2f" % (cart_item.food.price * cart_item.qty) }}</h5>
                                <h5 class="mb-0">${{ "%.2f" % cart_item.price }}</h5>
                            {% else %}
                                <h5 class="mb-0">${{ "%.2f" % cart_item.price }}</h5>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
    <div class="card rounded-3 mb-4">
        <div class="card-body p-4">
            <p class="lead fw-normal mb-2">
                Address:
                <br>
                {{ location }}
            </p>
            {% if del_time %}
                <p class="lead fw-normal mb-2">
                    Delivery Duration:
                    <br>
                    {{ "%d" % del_time }} mins
                </p>
            {% endif %}
            {% if del_fee %}
                <p class="lead fw-normal mb-2">
                    Delivery Fee:
                    <span style="position: absolute; right: 10%;">S$ {{ "%.2f" % del_fee }}</span>
                </p>
            {% endif %}

            <hr>
            <p class="lead fw-normal mb-2">
                Total
                <span style="position: absolute; right: 10%;">S$ {{ "%.2f" % cart.get_subtotal() }}</span>
            </p>

            {#            <button type="button"#}
            {#                    class="btn btn-warning btn-block btn-lg mt-auto mb-auto"#}
            {#                    style="height: 50%;">#}
            {#                Proceed to Pay#}
            {#            </button>#}

            {% if del_fee > 0.0 %}
            <form action="{{ url_for('payment') }}" method="POST">
                {#                <input type="hidden" name="amount" value="{{cart.get_subtotal() *100}}">#}
                {#                  {%  set amount = (cart.get_subtotal()).replace('.','')%}#}
                <script
                        src="https://checkout.stripe.com/checkout.js"
                        class="stripe-button"
                        data-key="pk_test_VrWD12lh918aMAaU4HP11c4e00I9shY8fg"
                        data-name="Payment to FoodyPulse"
                        data-description="Food on Impulse"
                        data-amount="{{ cart.get_subtotal() * 100 }}"
                        data-currency="sgd">
                </script>
            </form>
        {% endif %}

        </div>
    </div>

{% endblock %}